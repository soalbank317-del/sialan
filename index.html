<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIALAN – Home</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.css" rel="stylesheet">
<style>
body { font-family:"Inter", sans-serif; background-color:#fdfdfd; color:#2c3e50; margin:0; padding:0; }
footer { text-align:center; padding:20px 0; font-size:0.9rem; color:#6c757d; border-top:1px solid #e9ecef; background: linear-gradient(90deg,#ffffff,#f8f8f8); box-shadow: 0 -2px 6px rgba(0,0,0,0.04); }
section.container { background-color:#ffffff; border-radius:15px; padding:30px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
.btn-phoenix { font-weight:600; border-radius:12px; padding:0.6rem 1.4rem; margin-right:10px; cursor:pointer; border:none; transition: all 0.25s ease-in-out; color:#fff; box-shadow: 0 6px 18px rgba(0,0,0,0.08);}
.btn-login { background: linear-gradient(145deg,#6c63ff,#5a54d1);}
.btn-login:hover { transform: translateY(-2px); box-shadow:0 8px 22px rgba(0,0,0,0.12);}
.badge-status { font-weight:600; margin-right:0.5rem; }
#barChart { box-shadow:0 10px 20px rgba(0,0,0,0.08); border-radius:12px; }
</style>
</head>
<body>

<!-- Navbar Publik -->
<div id="navbar"></div>

<!-- Konten Home -->
<section class="container my-4">
  <h2 class="mb-4">Statistik Laporan KBM</h2>
  <canvas id="barChart" height="150"></canvas>
  <div id="statusBadges" class="mt-3"></div>
</section>

<!-- Modal Login -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Login Admin</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        <form id="loginForm">
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" required>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" required>
          </div>
          <button type="submit" class="btn btn-login w-100">Login</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer>
  © 2025 SIALAN – Sistem Analisis Laporan KBM Siswa
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

<script>
// Load Navbar
fetch('navbar_publik.html')
  .then(resp => resp.text())
  .then(html => document.getElementById('navbar').innerHTML = html)
  .then(()=> feather.replace());

// ===== Fetch CSV Data =====
async function fetchSheetData() {
  const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQAEwBLEhaehGYlzYsNhBPfmozGvRZmpjyEOHC8rfgduB0JRurz-xwI_jfW8Fw8Vaz93a_E9tLyuIX9/pub?gid=0&single=true&output=csv";
  const res = await fetch(url);
  const csvText = await res.text();
  const lines = csvText.split("\n").filter(l=>l.trim()!=="");
  const headers = lines[0].split(",");
  return lines.slice(1).map(line=>{
    const vals = line.split(",");
    const obj = {};
    headers.forEach((h,i)=>obj[h.trim()]=vals[i].trim());
    return obj;
  });
}

// ===== Render Chart =====
fetchSheetData().then(data=>{
  const kelasLabels = [...new Set(data.map(d=>d.Kelas))].sort();
  const mapelLabels = [...new Set(data.map(d=>d.Mata_Pelajaran))];
  const colors = ["#198754","#dc3545","#0d6efd","#ffc107","#6f42c1","#fd7e14","#20c997"];
  const ctx = document.getElementById('barChart').getContext('2d');
  const datasets = [];

  mapelLabels.forEach((mp, idx)=>{
    const colorTuntas = colors[idx % colors.length];
    const colorUjian  = colors[(idx+3) % colors.length];
    const tuntasData = kelasLabels.map(k=>data.filter(d=>d.Kelas===k && d.Mata_Pelajaran===mp && d.Status==="Tuntas").length);
    const ujianData  = kelasLabels.map(k=>data.filter(d=>d.Kelas===k && d.Mata_Pelajaran===mp && d.Status==="Ujian").length);

    datasets.push({
      label: mp+" Tuntas",
      data: tuntasData,
      backgroundColor: colorTuntas,
      borderRadius: 8,
      borderSkipped: false
    });
    datasets.push({
      label: mp+" Ujian",
      data: ujianData,
      backgroundColor: colorUjian,
      borderRadius: 8,
      borderSkipped: false
    });
  });

  new Chart(ctx, {
    type:'bar',
    data:{labels:kelasLabels,datasets:datasets},
    options:{
      responsive:true,
      plugins:{
        title:{
          display:true,
          text:'Jumlah Siswa Tuntas / Ujian per Kelas & Mata Pelajaran',
          font:{size:18, weight:'bold'}
        },
        legend:{position:'top', labels:{boxWidth:20, padding:10}},
        tooltip:{
          mode:'index',
          intersect:false,
          callbacks:{
            label: function(context){ return `${context.dataset.label}: ${context.parsed.y} siswa`; }
          }
        },
        datalabels:{
          anchor:'end',
          align:'end',
          color:'#000',
          font:{weight:'bold'},
          formatter: value => value > 0 ? value : ''
        }
      },
      interaction:{mode:'nearest', axis:'x', intersect:false},
      scales:{
        x:{stacked:true, grid:{display:false}, barPercentage:0.6, categoryPercentage:0.7},
        y:{stacked:true, beginAtZero:true, ticks:{stepSize:1}}
      },
      animation:{duration:1000, easing:'easeOutQuart'}
    },
    plugins:[ChartDataLabels]
  });

  // Badge Status
  const totalTuntas = data.filter(d=>d.Status==="Tuntas").length;
  const totalUjian   = data.filter(d=>d.Status==="Ujian").length;
  document.getElementById('statusBadges').innerHTML=
    `<span class="badge bg-success badge-status">Tuntas: ${totalTuntas}</span>
     <span class="badge bg-danger badge-status">Ujian: ${totalUjian}</span>`;
});

// ===== Modal Login =====
let userCredentials = [];
async function loadCredentials() {
  const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXOP4L2k61miTcFTlb4r0QigIWRsMzVazznXCbNLqaHBpwY9RKgjnXdW4figjJZLmrrPcXbU6Q1f-E/pub?gid=1201461529&single=true&output=csv";
  const res = await fetch(url);
  const csvText = await res.text();
  const lines = csvText.split("\n").slice(1);
  lines.forEach(line=>{
    const cols = line.split(",");
    const username = cols[2]?.trim(); 
    const password = cols[3]?.trim(); 
    if(username && password) userCredentials.push({username,password});
  });
}
loadCredentials();

document.getElementById('loginForm').addEventListener('submit', function(e){
  e.preventDefault();
  const inputUser = document.getElementById('username').value.trim();
  const inputPass = document.getElementById('password').value.trim();
  const found = userCredentials.find(u=>u.username===inputUser && u.password===inputPass);
  if(found){
    alert(`Login berhasil! Username: ${inputUser}`);
    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
    loginModal.hide();
  } else {
    alert("Username atau password salah!");
  }
});
</script>

</body>
</html>
