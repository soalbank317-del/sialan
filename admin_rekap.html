<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIALAN – Rekap KBM</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
    font-family: "Inter", sans-serif;
    background-color: #f8f9fa;
    color: #2c3e50;
}
footer {
    text-align: center;
    padding: 20px 0;
    font-size: 0.9rem;
    color: #6c757d;
    border-top: 1px solid #e9ecef;
    background: linear-gradient(90deg,#ffffff,#f8f8f8);
    box-shadow: 0 -2px 6px rgba(0,0,0,0.04);
}
.card {
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
    padding: 20px;
}
.table-hover tbody tr:hover {
    background-color: #f1f3f5;
}
</style>
</head>
<body>

<!-- Proteksi Login -->
<script>
const user = sessionStorage.getItem('user');
if(!user){
  alert('Anda belum login! Akses ditolak.');
  window.location.href = 'https://soalbank317-del.github.io/sialan/index.html';
}
</script>

<!-- Navbar Admin -->
<nav class="navbar navbar-expand-lg shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="">SIALAN – Admin Panel</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarAdminMenu" aria-controls="navbarAdminMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarAdminMenu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="https://soalbank317-del.github.io/sialan/admin_input.html">Input Data KBM</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" id="logoutBtn">Logout</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Overlay Blur & Toast Logout -->
<div id="overlayBlur" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-none" style="backdrop-filter: blur(4px); z-index: 1999;"></div>
<div class="position-fixed top-50 start-50 translate-middle p-3 d-none" id="toastWrapper" style="z-index: 2000;">
  <div id="logoutToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
    <div class="toast-header bg-danger text-white">
      <strong class="me-auto">Konfirmasi Logout</strong>
      <button type="button" class="btn-close btn-close-white" aria-label="Close" id="closeToast"></button>
    </div>
    <div class="toast-body text-center">
      Anda yakin ingin logout?
      <div class="mt-3">
        <button type="button" class="btn btn-light btn-sm me-2" id="confirmLogout">Ya, Logout</button>
        <button type="button" class="btn btn-outline-light btn-sm" id="cancelLogout">Batal</button>
      </div>
    </div>
  </div>
</div>

<section class="container my-4">
  <div class="card">
    <h3 class="mb-3">Rekap Data KBM</h3>

    <!-- Info Wali Kelas -->
    <div class="mb-3">
      <strong>Nama Wali Kelas:</strong> <span id="userName"></span><br>
      <strong>Kelas:</strong> <span id="userKelas"></span>
    </div>

    <!-- Filters -->
    <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
      <select id="filterKelas" class="form-select form-select-sm w-auto">
        <option value="">Semua Kelas</option>
      </select>
      <select id="filterMapel" class="form-select form-select-sm w-auto">
        <option value="">Semua Mata Pelajaran</option>
      </select>
      <select id="filterStatus" class="form-select form-select-sm w-auto">
        <option value="">Semua Status</option>
        <option value="Tuntas">Tuntas</option>
        <option value="Ujian">Ujian</option>
      </select>
      <input type="text" id="searchNama" class="form-control form-control-sm w-auto" placeholder="Cari nama siswa">
      <button class="btn btn-primary btn-sm" id="applyFilter">Terapkan</button>
      <button class="btn btn-secondary btn-sm" id="resetFilter">Reset</button>
      <label class="ms-2">Tampilkan:</label>
      <select id="rowsPerPage" class="form-select form-select-sm w-auto">
        <option value="15">15</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover rounded" id="rekapTable">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Wali Kelas</th>
            <th>Mata Pelajaran</th>
            <th>Kelas</th>
            <th>Nama Siswa</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div>Halaman <span id="pageNum">1</span> dari <span id="totalPages">1</span></div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="prevPage">Prev</button>
        <button class="btn btn-outline-secondary btn-sm" id="nextPage">Next</button>
      </div>
    </div>
  </div>
</section>

<footer>
  © 2025 SIALAN – Sistem Analisis Laporan KBM Siswa
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// --- Konfirmasi Logout ---
document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById('overlayBlur');
  const toastWrapper = document.getElementById('toastWrapper');
  const logoutToastEl = document.getElementById('logoutToast');
  const logoutBtn = document.getElementById('logoutBtn');
  const closeToast = document.getElementById('closeToast');
  const cancelLogout = document.getElementById('cancelLogout');
  const confirmLogout = document.getElementById('confirmLogout');

  const logoutToast = new bootstrap.Toast(logoutToastEl);

  function showLogoutToast() {
    overlay.classList.remove('d-none');
    toastWrapper.classList.remove('d-none');
    logoutToast.show();
  }
  function hideLogoutToast() {
    overlay.classList.add('d-none');
    toastWrapper.classList.add('d-none');
    logoutToast.hide();
  }

  logoutBtn?.addEventListener('click', (e) => { e.preventDefault(); showLogoutToast(); });
  closeToast?.addEventListener('click', hideLogoutToast);
  cancelLogout?.addEventListener('click', hideLogoutToast);
  overlay?.addEventListener('click', hideLogoutToast);
  confirmLogout?.addEventListener('click', ()=>{
    sessionStorage.clear();
    window.location.href = "https://soalbank317-del.github.io/sialan/index.html";
  });

  // Set nama user dari session
  document.getElementById('userName').textContent = user || 'Admin';
  document.getElementById('userKelas').textContent = '7A';
});

// --- Rekap KBM ---
let allData = [], filteredData = [], currentPage = 1, rowsPerPage = 15;
function formatIndoDateTime(dateStr) {
  const d = parseIndoDateTime(dateStr);
  const pad = n => String(n).padStart(2,'0');
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function parseIndoDateTime(dateStr){
  const [datePart, timePart] = dateStr.split(" ");
  if(!datePart) return new Date(dateStr);
  const [day, month, year] = datePart.split("/").map(Number);
  let hours=0, minutes=0, seconds=0;
  if(timePart) [hours, minutes, seconds]=timePart.split(":").map(Number);
  return new Date(year, month-1, day, hours, minutes, seconds);
}
function sortByLatestDate(data){ return data.sort((a,b)=>parseIndoDateTime(b.Tanggal)-parseIndoDateTime(a.Tanggal)); }
async function loadRekapData(){
  const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vQAEwBLEhaehGYlzYsNhBPfmozGvRZmpjyEOHC8rfgduB0JRurz-xwI_jfW8Fw8Vaz93a_E9tLyuIX9/pub?gid=0&single=true&output=csv";
  const res=await fetch(url);
  const csvText=await res.text();
  const lines=csvText.split("\n").filter(l=>l.trim()!=="");
  const headers=lines[0].split(",").map(h=>h.trim().replace(/\s+/g,"_"));
  return lines.slice(1).map(line=>{
    const vals=line.split(",");
    const obj={};
    headers.forEach((h,i)=>obj[h]=(vals[i]||"").trim());
    return obj;
  });
}
function renderTablePage(page){
  const tbody=document.querySelector('#rekapTable tbody');
  tbody.innerHTML='';
  const start=(page-1)*rowsPerPage;
  const end=start+rowsPerPage;
  filteredData.slice(start,end).forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${row.Tanggal?formatIndoDateTime(row.Tanggal):""}</td>
      <td>${row.Wali_Kelas||""}</td>
      <td>${row.Mata_Pelajaran||""}</td>
      <td>${row.Kelas||""}</td>
      <td>${row.Nama_Siswa||""}</td>
      <td>${row.Status||""}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('pageNum').textContent=currentPage;
  document.getElementById('totalPages').textContent=Math.ceil(filteredData.length/rowsPerPage);
}
function applyFilters(){
  const kelas=document.getElementById('filterKelas').value;
  const mapel=document.getElementById('filterMapel').value;
  const status=document.getElementById('filterStatus').value;
  const search=document.getElementById('searchNama').value.toLowerCase();
  filteredData=allData.filter(d=>
    (!kelas||d.Kelas===kelas)&&
    (!mapel||d.Mata_Pelajaran===mapel)&&
    (!status||d.Status===status)&&
    (!search||(d.Nama_Siswa||"").toLowerCase().includes(search))
  );
  filteredData=sortByLatestDate(filteredData);
  currentPage=1;
  renderTablePage(currentPage);
}
async function init(){
  allData=await loadRekapData();
  allData=sortByLatestDate(allData);
  filteredData=[...allData];
  const kelasSet=new Set(allData.map(d=>d.Kelas).filter(Boolean));
  const mapelSet=new Set(allData.map(d=>d.Mata_Pelajaran).filter(Boolean));
  kelasSet.forEach(k=>document.getElementById('filterKelas').innerHTML+=`<option value="${k}">${k}</option>`);
  mapelSet.forEach(m=>document.getElementById('filterMapel').innerHTML+=`<option value="${m}">${m}</option>`);
  renderTablePage(currentPage);
  document.getElementById('applyFilter').addEventListener('click',applyFilters);
  document.getElementById('resetFilter').addEventListener('click',()=>{
    document.getElementById('filterKelas').value='';
    document.getElementById('filterMapel').value='';
    document.getElementById('filterStatus').value='';
    document.getElementById('searchNama').value='';
    filteredData=sortByLatestDate([...allData]);
    currentPage=1;
    renderTablePage(currentPage);
  });
  document.getElementById('rowsPerPage').addEventListener('change',e=>{
    rowsPerPage=parseInt(e.target.value);
    currentPage=1;
    renderTablePage(currentPage);
  });
  document.getElementById('prevPage').addEventListener('click',()=>{if(currentPage>1){currentPage--;renderTablePage(currentPage);}});
  document.getElementById('nextPage').addEventListener('click',()=>{if(currentPage<Math.ceil(filteredData.length/rowsPerPage)){currentPage++;renderTablePage(currentPage);}});
}
init();
</script>

</body>
</html>
