<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Data</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 8px; text-align: left; }
  th { background: #f2f2f2; }
  .controls { margin-bottom: 10px; }
  select, input, button { margin-right: 5px; }
</style>
</head>
<body>

<h2>Rekap Data</h2>

<div class="controls">
  <label>Kelas: 
    <select id="filterKelas"><option value="">Semua</option></select>
  </label>
  <label>Mapel: 
    <select id="filterMapel"><option value="">Semua</option></select>
  </label>
  <label>Status: 
    <select id="filterStatus">
      <option value="">Semua</option>
      <option value="Selesai">Selesai</option>
      <option value="Belum">Belum</option>
    </select>
  </label>
  <label>Nama: 
    <input type="text" id="searchNama" placeholder="Cari nama...">
  </label>
  <button id="applyFilter">Terapkan</button>
  <button id="resetFilter">Reset</button>
  <label>Baris/Page: 
    <select id="rowsPerPage">
      <option value="15">15</option>
      <option value="25">25</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
  </label>
</div>

<table id="rekapTable">
  <thead>
    <tr>
      <th>Tanggal</th>
      <th>Kelas</th>
      <th>Mata Pelajaran</th>
      <th>Nama Siswa</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="controls">
  <button id="prevPage">Prev</button>
  <span id="pageInfo"></span>
  <button id="nextPage">Next</button>
</div>

<script>
let allData = [];
let filteredData = [];
let currentPage = 1;
let rowsPerPage = 15;

// Contoh fungsi load data CSV dari URL publik Google Sheets
async function loadRekapData() {
  const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vXXXXXXXXXX/pub?output=csv"; // ganti URL CSV-mu
  const res = await fetch(url);
  const text = await res.text();
  const rows = text.split("\n").map(r => r.split(","));
  const headers = rows[0];
  return rows.slice(1).map(row => {
    let obj = {};
    headers.forEach((h, i) => {
      obj[h.trim()] = row[i] ? row[i].trim() : "";
    });
    return obj;
  });
}

// Parse tanggal format DD/MM/YYYY
function parseIndoDate(dateStr) {
  const parts = dateStr.split("/");
  if (parts.length === 3) {
    return new Date(parts[2], parts[1] - 1, parts[0]);
  }
  return new Date(dateStr);
}

// Sortir data tanggal terbaru
function sortByLatestDate(data) {
  return data.sort((a, b) => parseIndoDate(b.Tanggal) - parseIndoDate(a.Tanggal));
}

// Render tabel sesuai halaman
function renderTablePage(page) {
  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start, end);

  const tbody = document.querySelector("#rekapTable tbody");
  tbody.innerHTML = "";
  pageData.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.Tanggal || ""}</td>
      <td>${d.Kelas || ""}</td>
      <td>${d.Mata_Pelajaran || ""}</td>
      <td>${d.Nama_Siswa || ""}</td>
      <td>${d.Status || ""}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("pageInfo").textContent =
    `Halaman ${currentPage} dari ${Math.ceil(filteredData.length / rowsPerPage)}`;
}

// Terapkan filter
function applyFilters() {
  const kelas = document.getElementById('filterKelas').value;
  const mapel = document.getElementById('filterMapel').value;
  const status = document.getElementById('filterStatus').value;
  const search = document.getElementById('searchNama').value.toLowerCase();

  filteredData = allData.filter(d =>
    (!kelas || d.Kelas === kelas) &&
    (!mapel || d.Mata_Pelajaran === mapel) &&
    (!status || d.Status === status) &&
    (!search || (d.Nama_Siswa || "").toLowerCase().includes(search))
  );

  filteredData = sortByLatestDate(filteredData);
  currentPage = 1;
  renderTablePage(currentPage);
}

// Inisialisasi
async function init() {
  allData = await loadRekapData();
  allData = sortByLatestDate(allData);
  filteredData = [...allData];

  const kelasSet = new Set(allData.map(d => d.Kelas).filter(Boolean));
  const mapelSet = new Set(allData.map(d => d.Mata_Pelajaran).filter(Boolean));

  const kelasSelect = document.getElementById('filterKelas');
  kelasSet.forEach(k => kelasSelect.innerHTML += `<option value="${k}">${k}</option>`);

  const mapelSelect = document.getElementById('filterMapel');
  mapelSet.forEach(m => mapelSelect.innerHTML += `<option value="${m}">${m}</option>`);

  renderTablePage(currentPage);

  document.getElementById('applyFilter').addEventListener('click', applyFilters);
  document.getElementById('resetFilter').addEventListener('click', () => {
    document.getElementById('filterKelas').value = '';
    document.getElementById('filterMapel').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('searchNama').value = '';
    filteredData = sortByLatestDate([...allData]);
    currentPage = 1;
    renderTablePage(currentPage);
  });

  document.getElementById('rowsPerPage').addEventListener('change', e => {
    rowsPerPage = parseInt(e.target.value);
    currentPage = 1;
    renderTablePage(currentPage);
  });

  document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderTablePage(currentPage);
    }
  });

  document.getElementById('nextPage').addEventListener('click', () => {
    if (currentPage < Math.ceil(filteredData.length / rowsPerPage)) {
      currentPage++;
      renderTablePage(currentPage);
    }
  });
}

init();
</script>

</body>
</html>
