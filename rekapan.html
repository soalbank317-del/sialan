<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rekap Data Siswa</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f0f0f0; }
  .pagination { margin-top: 10px; display: flex; align-items: center; gap: 10px; }
  .filter-bar { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
</style>
</head>
<body>

<h2>Rekap Data Siswa</h2>

<div class="filter-bar">
  <select id="filterKelas">
    <option value="">Semua Kelas</option>
  </select>
  <select id="filterMapel">
    <option value="">Semua Mapel</option>
  </select>
  <select id="filterStatus">
    <option value="">Semua Status</option>
    <option value="Selesai">Selesai</option>
    <option value="Belum">Belum</option>
  </select>
  <input type="text" id="searchNama" placeholder="Cari Nama Siswa...">
  <button id="applyFilter">Terapkan Filter</button>
  <button id="resetFilter">Reset</button>
</div>

<div>
  Tampilkan
  <select id="rowsPerPage">
    <option value="15">15</option>
    <option value="25">25</option>
    <option value="50">50</option>
    <option value="100">100</option>
  </select>
  baris per halaman
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>Tanggal</th>
      <th>Kelas</th>
      <th>Mata Pelajaran</th>
      <th>Nama Siswa</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="pagination">
  <button id="prevPage">Prev</button>
  <span id="pageInfo"></span>
  <button id="nextPage">Next</button>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vXXXXXXX/pub?output=csv";

let allData = [];
let filteredData = [];
let currentPage = 1;
let rowsPerPage = 15;

// Parse tanggal format "DD/MM/YYYY HH:MM:SS"
function parseIndoDateTime(dateStr) {
  const [datePart, timePart] = dateStr.split(" ");
  if (!datePart) return new Date(dateStr);

  const [day, month, year] = datePart.split("/").map(Number);
  let hours = 0, minutes = 0, seconds = 0;

  if (timePart) {
    [hours, minutes, seconds] = timePart.split(":").map(Number);
  }

  return new Date(year, month - 1, day, hours, minutes, seconds);
}

// Sortir data berdasarkan tanggal terbaru
function sortByLatestDate(data) {
  return data.sort((a, b) => parseIndoDateTime(b.Tanggal) - parseIndoDateTime(a.Tanggal));
}

// Load data dari Google Sheets CSV
async function loadRekapData() {
  const res = await fetch(SHEET_URL);
  const csvText = await res.text();
  const rows = csvText.split("\n").map(r => r.split(","));
  
  const headers = rows[0];
  return rows.slice(1).map(r => {
    let obj = {};
    headers.forEach((h, i) => obj[h.trim()] = (r[i] || "").trim());
    return obj;
  }).filter(d => d.Tanggal); // Buang baris kosong
}

// Render tabel per halaman
function renderTablePage(page) {
  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start, end);
  
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  pageData.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.Tanggal}</td>
      <td>${row.Kelas}</td>
      <td>${row.Mata_Pelajaran}</td>
      <td>${row.Nama_Siswa}</td>
      <td>${row.Status}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("pageInfo").textContent = `Halaman ${page} dari ${Math.ceil(filteredData.length / rowsPerPage)}`;
}

// Apply filter
function applyFilters() {
  const kelas = document.getElementById('filterKelas').value;
  const mapel = document.getElementById('filterMapel').value;
  const status = document.getElementById('filterStatus').value;
  const search = document.getElementById('searchNama').value.toLowerCase();

  filteredData = allData.filter(d =>
    (!kelas || d.Kelas === kelas) &&
    (!mapel || d.Mata_Pelajaran === mapel) &&
    (!status || d.Status === status) &&
    (!search || (d.Nama_Siswa || "").toLowerCase().includes(search))
  );

  filteredData = sortByLatestDate(filteredData);
  currentPage = 1;
  renderTablePage(currentPage);
}

// Inisialisasi
async function init() {
  allData = await loadRekapData();
  allData = sortByLatestDate(allData);
  filteredData = [...allData];

  const kelasSet = new Set(allData.map(d => d.Kelas).filter(Boolean));
  const mapelSet = new Set(allData.map(d => d.Mata_Pelajaran).filter(Boolean));

  const kelasSelect = document.getElementById('filterKelas');
  kelasSet.forEach(k => kelasSelect.innerHTML += `<option value="${k}">${k}</option>`);

  const mapelSelect = document.getElementById('filterMapel');
  mapelSet.forEach(m => mapelSelect.innerHTML += `<option value="${m}">${m}</option>`);

  renderTablePage(currentPage);

  document.getElementById('applyFilter').addEventListener('click', applyFilters);
  document.getElementById('resetFilter').addEventListener('click', () => {
    document.getElementById('filterKelas').value = '';
    document.getElementById('filterMapel').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('searchNama').value = '';
    filteredData = sortByLatestDate([...allData]);
    currentPage = 1;
    renderTablePage(currentPage);
  });

  document.getElementById('rowsPerPage').addEventListener('change', e => {
    rowsPerPage = parseInt(e.target.value);
    currentPage = 1;
    renderTablePage(currentPage);
  });

  document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderTablePage(currentPage);
    }
  });

  document.getElementById('nextPage').addEventListener('click', () => {
    if (currentPage < Math.ceil(filteredData.length / rowsPerPage)) {
      currentPage++;
      renderTablePage(currentPage);
    }
  });
}

init();
</script>

</body>
</html>
