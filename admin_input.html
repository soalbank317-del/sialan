<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIALAN – Input Data KBM</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family: "Inter", sans-serif; background-color: #f8f9fa; color: #2c3e50; }
.card { border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); padding: 20px; }
.table-hover tbody tr:hover { background-color: #f1f3f5; }
</style>
</head>
<body>

<!-- Toast Container -->
<div id="toastContainer" class="position-fixed top-50 start-50 translate-middle" style="z-index: 1080;"></div>

<div id="navbarContainer"></div>

<section class="container my-4">
  <div class="card">
    <h3 class="mb-3">Form Input Data KBM</h3>
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Wali Kelas</th>
            <th>Mata Pelajaran</th>
            <th>Kelas</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="date" id="tanggal" class="form-control"></td>
            <td><select id="waliKelas" class="form-select"><option value="">Pilih Wali Kelas</option></select></td>
            <td><select id="mataPelajaran" class="form-select"><option value="">Pilih Mata Pelajaran</option></select></td>
            <td><select id="kelas" class="form-select"><option value="">Pilih Kelas</option></select></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Tabel siswa -->
    <div class="table-responsive mt-3">
      <table class="table table-bordered table-hover" id="siswaTable">
        <thead>
          <tr>
            <th>Nama Siswa</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="siswaTableBody"></tbody>
      </table>
      <div class="mb-2">
        <button class="btn btn-success btn-sm" onclick="setStatusSemua('Tuntas')">Tuntas Semua</button>
        <button class="btn btn-danger btn-sm" onclick="setStatusSemua('Ujian')">Ujian Semua</button>
      </div>
    </div>

    <div class="mt-2">
      <button class="btn btn-primary" id="saveTableBtn" disabled>Simpan Data</button>
    </div>
  </div>
</section>

<footer class="text-center mt-3">
  © 2025 SIALAN – Sistem Analisis Laporan KBM Siswa
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Load Navbar
fetch('navbar_admin.html')
.then(res => res.text())
.then(html => document.getElementById('navbarContainer').innerHTML = html);

const waliKelasSelect = document.getElementById('waliKelas');
const kelasSelect = document.getElementById('kelas');
const mataPelajaranSelect = document.getElementById('mataPelajaran');
const siswaTableBody = document.getElementById('siswaTableBody');
const saveTableBtn = document.getElementById('saveTableBtn');

// --- Fungsi toast ---
function showToast(message, type='success', delay=3000){
  const toastContainer = document.getElementById('toastContainer');
  const toastId = 'toast' + Date.now();
  const toastHTML = `
    <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  toastContainer.insertAdjacentHTML('beforeend', toastHTML);
  const toastEl = document.getElementById(toastId);
  const bsToast = new bootstrap.Toast(toastEl, { delay: delay });
  bsToast.show();
  toastEl.addEventListener('hidden.bs.toast', ()=>toastEl.remove());
}

// --- Fetch Wali Kelas & Kelas ---
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQXOP4L2k61miTcFTlb4r0QigIWRsMzVazznXCbNLqaHBpwY9RKgjnXdW4figjJZLmrrPcXbU6Q1f-E/pub?gid=0&single=true&output=csv')
.then(res => res.text())
.then(csvText => {
  const lines = csvText.split("\n").slice(1);
  const kelasSet = new Set();
  lines.forEach(line=>{
    const cols = line.split(",");
    const wali = cols[0]?.trim();
    const kelas = cols[1]?.trim();
    if(wali) waliKelasSelect.innerHTML += `<option value="${wali}">${wali}</option>`;
    if(kelas && !kelasSet.has(kelas)) {
      kelasSelect.innerHTML += `<option value="${kelas}">${kelas}</option>`;
      kelasSet.add(kelas);
    }
  });
});

// --- Fetch Mata Pelajaran ---
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQXOP4L2k61miTcFTlb4r0QigIWRsMzVazznXCbNLqaHBpwY9RKgjnXdW4figjJZLmrrPcXbU6Q1f-E/pub?gid=1451676013&single=true&output=csv')
.then(res => res.text())
.then(csvText => {
  const lines = csvText.split("\n").slice(1);
  lines.forEach(line=>{
    const cols = line.split(",");
    const mapel = cols[0]?.trim();
    if(mapel) mataPelajaranSelect.innerHTML += `<option value="${mapel}">${mapel}</option>`;
  });
});

// --- Fetch Nama Siswa per Kelas ---
async function fetchSiswaPerKelas(kelasTerpilih){
  const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQXOP4L2k61miTcFTlb4r0QigIWRsMzVazznXCbNLqaHBpwY9RKgjnXdW4figjJZLmrrPcXbU6Q1f-E/pub?gid=852230839&single=true&output=csv';
  const res = await fetch(url);
  const csvText = await res.text();
  const lines = csvText.split("\n").slice(1);
  const siswaList = [];
  lines.forEach(line=>{
    const cols = line.split(",");
    const kelas = cols[0]?.trim();
    const nama = cols[1]?.trim();
    if(kelas === kelasTerpilih && nama) siswaList.push(nama);
  });
  return siswaList;
}

// --- Fungsi pewarnaan teks status ---
function updateStatusColor(selectEl){
  if(selectEl.value === "Tuntas") selectEl.style.color = "#198754"; // hijau
  else if(selectEl.value === "Ujian") selectEl.style.color = "#dc3545"; // merah
  else selectEl.style.color = "#000"; // hitam default
}

// --- Update tabel siswa saat pilih kelas ---
kelasSelect.addEventListener('change', async ()=>{
  const k = kelasSelect.value;
  siswaTableBody.innerHTML = '';
  if(!k) return;
  const siswaList = await fetchSiswaPerKelas(k);
  siswaList.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s}</td>
      <td>
        <select class="form-select" data-siswa="${s}">
          <option value="Tuntas">Tuntas</option>
          <option value="Ujian">Ujian</option>
        </select>
      </td>
    `;
    siswaTableBody.appendChild(tr);
    const selectEl = tr.querySelector('select');
    updateStatusColor(selectEl);
    selectEl.addEventListener('change', ()=>updateStatusColor(selectEl));
  });
  cekDataLengkap();
});

// --- Tombol Semua Tuntas / Semua Ujian ---
function setStatusSemua(value){
  siswaTableBody.querySelectorAll('select').forEach(sel=>{
    sel.value = value;
    updateStatusColor(sel);
  });
  showToast(`Semua siswa diubah menjadi "${value}"`, "info");
  cekDataLengkap();
}

// --- Cek data lengkap ---
function cekDataLengkap(){
  const tanggal = document.getElementById('tanggal').value;
  const waliKelas = waliKelasSelect.value;
  const mapel = mataPelajaranSelect.value;
  const kelas = kelasSelect.value;
  const semuaStatus = Array.from(siswaTableBody.querySelectorAll('select')).every(sel => sel.value);
  saveTableBtn.disabled = !(tanggal && waliKelas && mapel && kelas && semuaStatus && siswaTableBody.querySelectorAll('tr').length>0);
}

// Event untuk form utama + status siswa
document.getElementById('tanggal').addEventListener('change', cekDataLengkap);
waliKelasSelect.addEventListener('change', cekDataLengkap);
mataPelajaranSelect.addEventListener('change', cekDataLengkap);
siswaTableBody.addEventListener('change', cekDataLengkap);

// --- Simpan data ke Apps Script ---
saveTableBtn.addEventListener('click', ()=>{
  if(saveTableBtn.disabled){
    showToast("Form belum lengkap!", "warning");
    return;
  }

  const formData = {
    tanggal: document.getElementById('tanggal').value,
    waliKelas: waliKelasSelect.value,
    mapel: mataPelajaranSelect.value,
    kelas: kelasSelect.value,
    siswa: []
  };
  siswaTableBody.querySelectorAll('select').forEach(sel=>{
    formData.siswa.push({nama: sel.dataset.siswa, status: sel.value});
  });

  showToast("Mengirim data...", "info");

  fetch('https://script.google.com/macros/s/AKfycbxtv-QilDJHlHYU0oHKnLc8eJymm9wufTpcsej1iXDZXo9hndOwUTUqmCPz0fG0Xbpr/exec', {
    method: 'POST',
    body: JSON.stringify(formData),
    headers: { 'Content-Type': 'application/json' }
  })
  .then(res => res.json())
  .then(res => {
    if(res.result === "success") {
      showToast("Data berhasil disimpan!", "success");
      document.getElementById('tanggal').value = '';
      waliKelasSelect.value = '';
      mataPelajaranSelect.value = '';
      kelasSelect.value = '';
      siswaTableBody.innerHTML = '';
      saveTableBtn.disabled = true;
    } else {
      showToast("Gagal menyimpan data: " + res.message, "danger");
    }
  })
  .catch(err => {
    console.error(err);
    showToast("Terjadi error saat menyimpan.", "danger");
  });
});
</script>
</body>
</html>

