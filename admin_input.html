<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIALAN – Input Data KBM</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family: "Inter", sans-serif; background-color: #f8f9fa; color: #2c3e50; }
.card { border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); padding: 20px; }
</style>
</head>
<body>

<div id="navbarContainer"></div>

<section class="container my-4">
  <div class="card">
    <h3 class="mb-3">Form Input Data KBM</h3>
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Wali Kelas</th>
            <th>Mata Pelajaran</th>
            <th>Kelas</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="date" id="tanggal" class="form-control"></td>
            <td>
              <select id="waliKelas" class="form-select"><option value="">Pilih Wali Kelas</option></select>
            </td>
            <td>
              <select id="mataPelajaran" class="form-select"><option value="">Pilih Mata Pelajaran</option></select>
            </td>
            <td>
              <select id="kelas" class="form-select"><option value="">Pilih Kelas</option></select>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Modal Pilih Siswa -->
<div class="modal fade" id="siswaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Pilih Nama Siswa & Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="siswaForm"></form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="saveSiswaBtn">Simpan</button>
      </div>
    </div>
  </div>
</div>

<footer class="text-center mt-3">
  © 2025 SIALAN – Sistem Analisis Laporan KBM Siswa
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Load Navbar
fetch('navbar_admin.html')
.then(res => res.text())
.then(html => document.getElementById('navbarContainer').innerHTML = html);

// Elemen
const waliKelasSelect = document.getElementById('waliKelas');
const kelasSelect = document.getElementById('kelas');
const mataPelajaranSelect = document.getElementById('mataPelajaran');
const siswaForm = document.getElementById('siswaForm');
const saveSiswaBtn = document.getElementById('saveSiswaBtn');

// --- Fetch Wali Kelas & Kelas ---
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQXOP4L2k61miTcFTlb4r0QigIWRsMzVazznXCbNLqaHBpwY9RKgjnXdW4figjJZLmrrPcXbU6Q1f-E/pub?gid=0&single=true&output=csv')
.then(res => res.text())
.then(csvText => {
    const lines = csvText.split("\n").slice(1);
    const kelasSet = new Set();
    lines.forEach(line=>{
        const cols = line.split(",");
        const wali = cols[0]?.trim();
        const kelas = cols[1]?.trim();
        if(wali) waliKelasSelect.innerHTML += `<option value="${wali}">${wali}</option>`;
        if(kelas && !kelasSet.has(kelas)) {
          kelasSelect.innerHTML += `<option value="${kelas}">${kelas}</option>`;
          kelasSet.add(kelas);
        }
    });
});

// --- Fetch Mata Pelajaran ---
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQXOP4L2k61miTcFTlb4r0QigIWRsMzVazznXCbNLqaHBpwY9RKgjnXdW4figjJZLmrrPcXbU6Q1f-E/pub?gid=1451676013&single=true&output=csv')
.then(res => res.text())
.then(csvText => {
    const lines = csvText.split("\n").slice(1);
    lines.forEach(line=>{
        const cols = line.split(",");
        const mapel = cols[0]?.trim();
        if(mapel) mataPelajaranSelect.innerHTML += `<option value="${mapel}">${mapel}</option>`;
    });
});

// --- Fetch Nama Siswa per Kelas dari Spreadsheet ---
async function fetchSiswaPerKelas(kelasTerpilih){
  const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQXOP4L2k61miTcFTlb4r0QigIWRsMzVazznXCbNLqaHBpwY9RKgjnXdW4figjJZLmrrPcXbU6Q1f-E/pub?gid=852230839&single=true&output=csv';
  const res = await fetch(url);
  const csvText = await res.text();
  const lines = csvText.split("\n").slice(1);
  const siswaList = [];
  lines.forEach(line=>{
    const cols = line.split(",");
    const kelas = cols[0]?.trim();
    const nama = cols[1]?.trim();
    if(kelas === kelasTerpilih && nama) siswaList.push(nama);
  });
  return siswaList;
}

// --- Show Modal saat pilih kelas ---
kelasSelect.addEventListener('change', async ()=>{
  const k = kelasSelect.value;
  if(!k) return;

  const siswaList = await fetchSiswaPerKelas(k);
  siswaForm.innerHTML = '';
  siswaList.forEach(s=>{
    const div = document.createElement('div');
    div.classList.add('mb-2');
    div.innerHTML = `
      <label>${s}</label>
      <select class="form-select" data-siswa="${s}">
        <option value="Tuntas">Tuntas</option>
        <option value="Ujian">Ujian</option>
      </select>
    `;
    siswaForm.appendChild(div);
  });

  const siswaModal = new bootstrap.Modal(document.getElementById('siswaModal'));
  siswaModal.show();
});

// --- Simpan data siswa & status ---
saveSiswaBtn.addEventListener('click', ()=>{
  const dataSiswa = [];
  siswaForm.querySelectorAll('select').forEach(sel=>{
    dataSiswa.push({nama: sel.dataset.siswa, status: sel.value});
  });
  console.log("Data siswa & status:", dataSiswa);
  alert("Data siswa & status berhasil dipilih!");
});
</script>
</body>
</html>
